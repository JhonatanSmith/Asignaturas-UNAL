---
title: | 
  <center> Parcial 3 Multivariado </center>
  <center> IAM </center>
author: | 
  <center> Jhonatan Smith Garcia M </center>
  <center> C.C 1039705595 </center>
  
date: "Mayo, 2022"
output:
  prettydoc::html_pretty:
    theme: cayman
    highlight: github
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#  1: Realizar prueba de igualdad de matrices de covarianza para las dos poblaciones:

Para el calculo de la igualdad de matrices de covarianza se deseea probar que:

$$
\left\{\begin{array}{l}
H_{0}: \mathbf{\Sigma}=\mathbf{\Sigma}_{0} \\
H_{a}: \mathbf{\Sigma} \neq \mathbf{\Sigma}_{0}
\end{array}\right.
$$


```{r}
library(MVN)
library(tidyverse)
bd <- read.table("datos34.txt", sep = "", header = T) #Insercion base de datos
```


```{r}
g1 <- bd %>% filter(grupos == 1) # POblacion 1
g2 <- bd %>% filter(grupos == 2) # Poblacion 2
```

Lo que se desea observar es si la matriz de varianzas y covarianzas de c/d poblacion
es igual o no. Para esto, se tiene la siguiente funcion de usuario:

```{r}

# Para probar matriz de var-cov iguales
# M_test de Box H0: MatrizSigma1 = MatrizSigma2 = MatrizSigma
# H1: Matrices var-cov diferentes
M_test <- function(listadatos, alpha) {
  
  g <- length(listadatos)
  p <- dim(listadatos[[1]])[2]
  
  Sl <- lapply(listadatos, var)
  vl <- unlist(lapply(listadatos, function(x) dim(x)[1] -1 ))
  v <- sum(vl)
  temp1 <- 0
  temp2 <- 0
  
  for (i in 1:g) {
    temp1 <- vl[i]*Sl[[i]] + temp1
    temp2 <- vl[i]*log(det(Sl[[i]])) + temp2
  }
  
  Sp <- (1/v)*temp1
  M <- v*log(det(Sp)) - temp2
  
  u <- (sum(1/vl) - 1/v)*(2*p^2 + 3*p - 1 )/(6*(p+1)*(g-1))
  C <- (1-u)*M
  k <- (g-1)*p*(p+1)/2
  pvalor <- pchisq(C, k, lower.tail = F)
  reject <- C > qchisq(alpha, k, lower.tail = F)
  list(pvalor = pvalor, C = C, reject = reject)
}


```


```{r}
M_test(list(g1[, -5], g2[, -5]), 0.05)
```
Dado el valor P> Alfa dado (para este caso, 0.05) hay evidencia para NO rechazar la hipotesis nula por tanto se concluye que ambas matrices de var-cov son iguales.

# 2: Realizar prueba de igualdad de vectores de medias poblacionales para las dos poblaciones consideradas:

Considere la siguiente funcion de usuario que automatiza el proceso.

```{r}

two_mu_sigmaequals_unknown <- function(datos1, datos2, alpha, delta0 = NULL) {
  #difference of means equals to delta0 if varcovs are unknow and equals
  p <- dim(datos1)[2]
  n <- dim(datos1)[1]
  m <- dim(datos2)[1]
  
  if (is.null(delta0)) {
    delta0 <- matrix(rep(0, p), ncol = 1)
  } else {
    delta0 <- matrix(delta0, ncol = 1)
  }
  
  xbar <- matrix(apply(datos1, 2, mean), ncol = 1)
  ybar <- matrix(apply(datos2, 2, mean), ncol = 1)
  S1 <- var(datos1)
  S2 <- var(datos2)
  Sp <- ((n-1)*S1 + (m-1)*S2)/(n+m-2)
  k <- (n+m-2)*p/(n+m-p-1)
  f0 <- (n*m)/((n+m)*k)*t(xbar - ybar - delta0) %*% solve(Sp) %*% (xbar - ybar - delta0)
  pvalue <- pf(f0, p, n+m-p-1, lower.tail = F)
  reject <- f0 > qf(alpha, p, n+m-p-1, lower.tail = F)
  list(pvalue = pvalue, f0 = f0, reject = reject)
  
}

```

Esta funcion de usuario considera que ambas matrices de var-cov son iguales. Ademas, supone que la matriz es desconocida y ha de ser estimada. Esto se hace asi debido a que no hay mencion alguna en el enunciado de dicha matriz. 

Entonces, para este caso, se desea probar que:


$$
\left\{\begin{array}{l}
H_{0}: \underline{\mu_1}=\underline{\mu_2}\\
H_{a}: \underline{\mu_1}\neq\underline{\mu_2}\\
\end{array}\right.
$$

Donde mu1 es la media de la poblacion 1 y mu2 es la media de la poblacion 2.

```{r}
two_mu_sigmaequals_unknown(g1[, -5], g2[, -5], 0.05)
```

A un nivel de significancia de 0.05 existe evidencia para NO rechazar la hipotesis nula, por tanto se concluye los vectores de medias son iguales. Analicemos esto con los datos; Notar que:

```{r}

# comparando medias de las poblaciones

apply(g1,MARGIN =2,FUN = mean ) # Media poblacion 1
apply(g2,MARGIN =2,FUN = mean ) # Media poblacion 2

```

Note que los vectores de medias son muy parecidos. Es esperable entonces que la prueba de hipotesis arrojase dicho resultado.

# 3: Prueba de hipotesis para la media de la poblacion 1:

Se desea saber si la poblacion 1 tiene media mu0. 

El juego de hipotesis a resolver es el siguiente:

$$
\left\{\begin{array}{l}
H_{0}: \underline{\mu_1}=\underline{\mu_{0}} \\
H_{a}: \underline{\mu_1} \neq \underline{\underline{\mu_{0}}}
\end{array}\right.
$$


Se tiene la siguiente funcion de usuario programada para realizar este procedimiento:

Esta funcion recibe el vector mu0 de la prueba de hipotesis, los datos a trabajar y el alpha del nivel de significancia. 

```{r}
mu_nosigma <- function(mu0, datos, alpha){
  mu0 <- matrix(mu0, ncol = 1)
  xbar <- apply(datos, 2, mean)
  xbar <- matrix(xbar, ncol = 1)
  n <- dim(datos)[1]
  p <- dim(datos)[2]
  S <- var(datos)
  k <- (n-1)*p/(n-p)
  f <- (n/k)*t(xbar-mu0) %*% solve(S) %*% (xbar-mu0)
  pvalue <- pf(f, df1 = p, df2 = n-p, lower.tail = F)
  reject <- f > qf(alpha, df1 = p, df2 = n-p, lower.tail = F)
  list(pvalue = pvalue, f0 = f, reject = reject)
}
```

```{r}
mu0 <-c(3.52904,0.41646,4.32413,1.30382)
mu_nosigma(mu0, g1[, -5], 0.05)

```
Dado el valor p que es muy cercano a cero, para este caso<alpha de 0.05 se concluye que hay evidencia suficiente para rechazar H0 a favor de H1 por tanto, la media de la poblacion 1 es diferente al vector $\mu_0$ dado.

Analicemos esto ultimo.

```{r}
apply(g1[,-5], MARGIN = 2, FUN = mean) # Media de la poblacion 1
```
Note que este vector de medias dista bastante del planteado en el juego de hipotesis, la prueba es consistente con los datos.

# 4: Suponga que la base de datos pertenece a una unica muestra aleatoria de tamaÃ±o n. Realice el sgte juego de hipotesis.

$$
\left\{\begin{array}{l}
H_{0}: \underline{\mu}=\underline{\mu_{0}} \\
H_{a}: \underline{\mu} \neq \underline{\underline{\mu_{0}}}
\end{array}\right.
$$
Se tiene la siguiente funcion de usuario, que recibe el vector mu0 de la prueba, los datos y el nivel de significancia. Ahora, esta funcion se basa en el teorema de limite central para datos multivariantes.

```{r}

#PH para mu usando TLC: 
mu_nosigma_lct <- function(mu0, datos, alpha){
  if(!is.matrix(mu0)){
    mu0 <- matrix(mu0, ncol = 1)
  }
  n <- dim(datos)[1]; p <- dim(datos)[2]
  x_bar <- apply(datos, 2, mean) %>% as.matrix(ncol = 1)
  S <- var(datos)
  Chi_02 <- n * t(x_bar - mu0) %*% solve(S) %*% (x_bar - mu0)
  RR <- Chi_02 > qchisq(alpha, p, lower.tail = F)
  pvalue <- pchisq(Chi_02, p, lower.tail = F)
  overall <- list(pvalue = pvalue, Chi_Squared_Statistic = Chi_02,
                  Quantile = qchisq(alpha, p, lower.tail = F),
                  Reject = RR)
  return(overall)
} 


```

```{r}
mu0 <-c(3.52904,0.41646,4.32413,1.30382)
mu_nosigma_lct(mu0, bd[, -5], 0.05)

```

Como el p-value < alpha dado de 0.05 se rechaza la hipotesis nula a favor de la alterna y se concluye que la media poblacional de los datos es diferente al vector $\underline{\mu_0}$ dado

Nuevamente, notar que:

```{r}
apply(bd[,-5], 2, mean)
```
Nuevamente, este vector de medias difiere mucho del veector mu0 de la prueba de hipotesis. Nuevamente, la prueba de hipotesis es consistente con los datos.

# 5: Para todo el conjunto completo, realice la prueba pedida.

$$
\left\{\begin{array}{l}
H_{0}: \underline{\mu}_{1}-\underline{\mu}_{2}=0 ;\underline{\mu}_{3}-\underline{\mu}_{4}=0 \\
H_{a}: \underline{\mu}_{1}-\underline{\mu}_{2} \neq 0 \underline{\mu}_{3}-\underline{\mu}_{4}=0 
\end{array}\right.
$$

Para este caso, se tiene la siguiente funcion de usuario, a la cual se le debe de ingresar la matriz C que representa los escalares de la forma matricial de las pruebas de hipotesis, los datos, el gamma al que se iguala y el nivel de significancia alpha.

```{r}

contrast_sigma_unknown <- function(datos, C, gamma, alpha) {
  
  k <- length(gamma)
  n <- dim(datos)[1]
  
  gamma <- matrix(gamma, ncol = 1)
  xbar <- matrix(apply(datos, 2, mean), ncol = 1)
  unb <- C %*% xbar
  S <- var(datos)
  varcov <- C %*% S %*% t(C)
  
  c <- (n-1)*k/(n-k)
  
  f0 <- (n/c)*t(unb-gamma) %*% solve(varcov) %*% (unb-gamma)
  pvalue <- pf(f0, k, n-k, lower.tail = F)
  reject <- f0 > qf(alpha, k, n-k, lower.tail = F)
  list(pvalue = pvalue, f0 = f0, reject = reject)
  
  
}


```



```{r}

C <- matrix(c(1, -1, 0, 0,
              0, 0, 1, -1), byrow = T, ncol = 4)


gamma <- c(0, 0) # Vector al cual se igualan las pruebas de hipotesis

contrast_sigma_unknown(bd[, -5], C, gamma, 0.05)

```

Dado entonces los anteriores resultados, como el valor p<alpha dado, hay evidencia para rechazar la hipotesis nula y por tanto se acepta la hipotesis alternativa y se puede asegurar que$C*\underline{\mu}\neq\gamma$ para los valores dados de C,mu y gamma. (gamma es el vector nulo)


NOTA: PARA TODOS ESTOS CALCULOS, n se considera grande para n>30. Esto, por regla empirica de la normal estandar multivariante (Texto guia)

