---
title: "Ejercicio 4 smith"
author: "Jhonatan Smith Garcia"
date: "14/1/2022"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 3)

```{r include=FALSE}
require(ISLR)
```

Considere la base de datos "Credit" del paquete ISLR. Se procede a analizar un conjunto de datos simulados de 10.000 clientes. Suponga a "Balance" como variable de interes. 

A continuacion, se realiza una breve descripcion de las variables de la base de datos:

 *ID:* Identificacion
 *Income:* Ingresos en $10.000
 *Limit:* Límite de crédito
 *Rating:* Calificacion crediticia
 *Age:* edad
 *Education:* Numeros de años de estudio
 *Cards:* Numero de tarjetas de credito
 *Gender:* Genero
 *Student:* Un factor con niveles "Si" y "no" que indica si el individuo es o no estudiante
 *Married:* Factor con niveles "Si" y "No" Que indica si el individuo está casado
 *Ethnicity:* Un factor de niveles "Afrodescendiente", "Asiatico", "caucasico" que indica la etnia del individuo. 
 *Balance:* saldo promedio de la tarjeta de credito en $

Un primer acercamiento a los datos se realiza con un analisis descriptivo de los mismos. Esto, con la intencion de en un principio, entender y ver el comportamiento de los datos dado el problema planteado (predecir acorde a la variable de interes Balance).


```{r echo=FALSE, warning=FALSE}
Credit = Credit
attach(Credit)
```

```{r echo=FALSE}
pairs(Balance~ Education+Age+Cards+Rating+Limit+Income, data = Credit, col = "skyblue")
```

Este grafico se utiliza para ver tendencia entre los datos de tipo numerico. Se observa que existe relaciones entre ciertas variables.
Por ejemplo, Limit y Rating tienen una tendencia positiva, asi como Limit e Income.

La variable respuesta Balance se relaciona de manera positiva con limit y rating.

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
par(mfrow=c(2,3))
boxplot(Income~Gender, main = "Gender vs Income")
boxplot(Limit~Gender, main = "Gender vs Limit")
boxplot(Rating~Gender, main = "Gender vs Rating")
boxplot(Cards~Gender, main = "Gender vs Cards")
boxplot(Age~Gender, main = "Gender vs Age")
boxplot(Education~Gender, main = "Gender vs Education")
boxplot(Balance~Gender, main = "Gender vs Balance")
boxplot(Income~Student, main = "Student vs Income")
boxplot(Limit~Student, main = "Student vs Limit")
boxplot(Rating~Student, main = "Student vs Rating")
boxplot(Cards~Student, main = "Student vs Cards")
boxplot(Age~Student, main = "Student vs Age")
boxplot(Education~Student, main = "Education vs Student")
boxplot(Balance~Student, main = "Balance vs Student")
boxplot(Income~Married, main = "Married vs Income")
boxplot(Limit~Married, main = "Married vs Limit")
boxplot(Rating~Married, main = "Married vs Rating")
boxplot(Cards~Married, main = "Married vs Cards")
boxplot(Age~Married, main = "Married vs Age")
boxplot(Education~Married, main = "Married vs Education")
boxplot(Balance~Married, main = "Married vs Balance")
boxplot(Income~Ethnicity, main = "Ethnicity vs Income")
boxplot(Limit~Ethnicity, main = "Ethnicity vs Limit")
boxplot(Rating~Ethnicity, main = "Ethnicity vs Rating")
```


```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
par(mfrow=c(2,2))
boxplot(Cards~Ethnicity, main = "Ethnicity vs Cards")
boxplot(Age~Ethnicity, main = "Ethnicity vs Age")
boxplot(Education~Ethnicity, main = "Ethnicity vs Education")
boxplot(Balance~Ethnicity, main = "Ethnicity vs Balance")

```


El anterior es un analisis descriptivo de las variables categoricas vs continuas. En general no se observan diferencias por categorias exceptuando *Student vs Balance* donde las personas que fueron estudiantes en promedio, tenian un saldo de tarjetas mas altos.  


Dado en analisis anterior se decide tomar el conjunto de variables Income, Limit, Student y Rating para modelar a Balance. Se ajustan los modelos GAM anidados de la siguiente manera.

```{r message=FALSE, warning=FALSE}
require(gam)

modelo.gam.1 <- gam(Balance~Limit+Rating, data = Credit)
modelo.gam.2 <- gam(Balance~Limit+Rating+Student, data = Credit)
modelo.gam.3 <- gam(Balance~Limit+Rating+Student+Income, data = Credit)
modelo.gam.4 <- gam(Balance~Limit+Rating+Student+s(Income, df = 3), data = Credit)

anova(modelo.gam.1,modelo.gam.2,modelo.gam.3,modelo.gam.4, test = "F")
```

Se observa que el p-value de los modelos 2 y 3 es pequeño. Esto se traduce en que las variables Income y Student son de importancia para explicar el comportamiento de Balance. Sin embargo, esto complica la variable Income con dos nodos ya que no hay un aporte significativo para el modelo. En general, aplicar un modelo con n nodos (n>0) complica el modelo y no hay una ganancia significativa. 

La seleccion del modelo para explicar Balance (Saldo en Tarjeta de Credito), se procede a realizar validacion cruzada (CV) con la base de datos, dividiendo un 70% para entrenamiento y un 30% para prueba.

```{r}
set.seed(1998)

prop = 0.7
t1 = sample(length(Credit$Balance), size = (length(Credit$Balance)*prop))

train = Credit[t1,]
test <- Credit[-t1,]
y = train$Balance
y1 <- test$Balance
```


Esta es la forma en que se seleccionan las bases de datos para ajustar cada uno de los modelos anterior mente seleccionados. Se procede a analizar el MSE de los modelos y dado este criterio se decide cual modelo es el más optimo a trabajar.

```{r}

modelo.gam.1.t <- gam(Balance~Limit+Rating, data = train)
modelo.gam.2.t <- gam(Balance~Limit+Rating+Student, data = train)
modelo.gam.3.t <- gam(Balance~Limit+Rating+Student+Income, data = train)
modelo.gam.4.t <- gam(Balance~Limit+Rating+Student+s(Income, df = 3), data = train)

```

Note algo. Se parte del modelo mas sencillo, hasta un modelo mas complejo. Se procede a realizar un analisis de varianza con la tabla ANOVA de los datos de entrenamiento. 

```{r}
anova(modelo.gam.1.t, modelo.gam.2.t, modelo.gam.3.t,modelo.gam.4.t, test = "F")
```

Note que el modelo 4, que utiliza un spline (complicando el proceso) no tuvo un efecto significativo. Por este motivo, el modelo 4 es descartado. 

Ahora, el modelo 2 y 3 son significativos, lo que indica que el agregar las variables (partiendo del modelo 1) y llegar hasta el modelo 3, es el modelo que mejor explica la proporcion de varianza. Surje una pregunta. ¿Que variable tiene papel preponderante para el modelo?

```{r echo=FALSE}
a=summary(modelo.gam.3.t)
a$parametric.anova
```

En general, la variable que mayor proporcion de varianza explica de Balance es Limit. Esto se cumple para todos los otros modelos. Esto indica que Limit es una variable que si o si, debe de ir en cualquier modelo que sea seleccionado. Todas las variables son significativas. 

Se procede a analizar el AIC de cada modelo. 

```{r echo=FALSE, warning=FALSE}
require(magrittr)
require(kableExtra)
```

```{r}
gam1<-modelo.gam.1.t$aic
gam2<-modelo.gam.2.t$aic
gam3<-modelo.gam.3.t$aic
gam4<-modelo.gam.4.t$aic

tabla = cbind(c(gam1,gam1, gam3, gam4))
colnames(tabla) = c("AIC")
rownames(tabla )=c("modelo 1", "modelo 2", "modelo 3", "modelo 4") 
tabla
```

Por criterio de AIC, se escoje el modelo 3 nuevamente. Si bien, no es el que tiene el valor minimo, su diferencia es infima respecto a la ganancia obtenida vs la complejidad del mejor (modelo 4) por tal motivo, se escoje nuevamente el modelo 3. Ahora, se procede a comparar los MSE de todos los modelos entre si con los datos de prueba. 


```{r}

mse1 <- mean((y1- predict(modelo.gam.1.t, test))^2)
mse2 <- mean((y1- predict(modelo.gam.2.t, test))^2)
mse3 <- mean((y1- predict(modelo.gam.3.t, test))^2)
mse4 <- mean((y1- predict(modelo.gam.4.t, test))^2)

tabla1 = cbind(c(mse1, mse2,mse3,mse4))
colnames(tabla1) = c("MSE")
rownames(tabla1)=c("modelo 1 ", "modelo 2 ", "modelo 3 ", "modelo 4 ") 
tabla1

```
El modelo con un menor MSE es el modelo 4. Sin embargo, la ganancia no es mucha respecto al modelo 3 dado que utiliza splines en el proceso. Finalmente, el modelo mas optimo dado el principio de parsimonia y, dado el criterio del MSE (No necesariamente el menor) y AIC, el modelo a seleccionar es el modelo que predice Balance con las variables Limit, Rating, Student e Income.
