---
header-includes:
- \usepackage{longtable}
- \usepackage[utf8]{inputenc}
- \usepackage[spanish]{babel}\decimalpoint
- \setlength{\parindent}{1.25cm}
- \usepackage{amsmath}
- \usepackage{xcolor}
- \usepackage{cancel}
- \usepackage{array}
- \usepackage{float}
- \usepackage{multirow}
output:
  pdf_document: 
    number_sections: yes
fontsize: 12pt
papersize: letter
geometry: margin = 1in
language: "es"
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}

# Librerias a utilizar

knitr::opts_chunk$set(echo = T, fig.align = "center",
                      fig.height = 3.2, fig.pos = "H")
library(kableExtra)
library(knitr)
library(tidyverse)
library(magrittr)
library(latex2exp)
library(ggridges)
require(ggplot2)
library(tidyr)
library(viridis)
require(readxl)
require(survival)
require(lattice)
library(readr)
```

```{=tex}
\input{titlepage}
\thispagestyle{empty}
\tableofcontents
\newpage
```

```{=tex}
\pagestyle{myheadings}
\setcounter{page}{4}
```

\section{Ejercicio 1}

En las siguientes situaciones identifique: el evento de interes y la variable respuesta.

**Solucion** 

*a)* Se realiza un seguimiento durante 13 años a un grupo de adultos de al menos 60 años de edad para ver
que tanto tiempo permanecen vivos.

* Evento de interes: Fallecimiento 

* Variable respuesta: Tiempo de supervivencia en años para los adultos de al menos 60 años de edad

*b)* Un grupo de pacientes con un trasplante de corazon son monitoreados para ver cuanto tiempo sobreviven

* Evento de interes: La muerte

* Tiempo de supervivecia para pacientes que han sido sometidos a transplante de corazon.



\section{Ejercicio 2}

Resuelva a MANO, usando los datos sobre Hepatitis Crónica Activa (CAH). Estos datos son de un ensayo clinico descrito en Kirk (1980). 44 pacientes con CAH se aleatorizaron a una droga llamada prednisolona o a un grupo de control sin tratamiento. El tiempo de supervivenvia en meses, despues de ser admitido al ensayo es la variables respuesta. Con estos datos obtenga una estimación de KM y el de NA. Note que debe evidenciar tablas de vida. No olvide el analisis descriptivo. Interprete


**Solucion**

A continuacion se muestra ña estructura general de la base de datos. Tenga presente que se tienen ensayos clinicos para 44 pacientes, donde existen dos grupos: Control con tratamiento y control sin tratamiento. 1 Representa fallas y 0 representa las censuras. Se presentan los primeros 6 datos de la tabla de manera ilustrativa.


```{r echo=FALSE}

df <- read_table("C:/Users/jhsga/OneDrive/Escritorio/GitHub/Asignaturas-UNAL/SUPERVIVENCIA/CAH.txt")
df %>% head() %>% kable()
```

Esta informacion puede ser resumida de la siguiente manera:

Tabla 1: Tabla de vida grupo 1

| $t_j$ | $d_j$ | $q_j$ | $n_j$ |
| ---: | :---: | :---: | ---: |
| $t_0$=0 | 0 | 0 | 22(22 unidades sobreviven >= 0 meses ) |
| $t_1$=2 | 2 | 0 | 22(22 unidades sobreviven >= 2 meses ) |
| $t_2$=12 | 1 | 0 | 20(20 unidades sobreviven >= 12 meses ) |
| $t_3$=54 | 1 | 1 | 19(19 unidades sobreviven >= 54 meses ) |
| $t_4$=68 | 1 | 0 | 17(17 unidades sobreviven >= 68 meses ) |
| $t_5$=89 | 1 | 0 | 16(16 unidades sobreviven >= 89 meses ) |
| $t_6$=96 | 2 | 5 | 15(15 unidades sobreviven >= 96 meses ) |
| $t_7$=143 | 1 | 1 | 8(8 unidades sobreviven >= 143 meses ) |
| $t_8$=146 | 1 | 2 | 6(6 unidades sobreviven >= 146 meses ) |
| $t_9$=168 | 1 | 2 | 3(3 unidades sobreviven >= 168 meses ) |
| TOTAL | 11 | 11 | 11+11=22 |

Con esto, es necesario analizar el tiempo promedio $\hat{T}$ y el Hazar $\hat{h}$ para el grupo 1 que se define respectivamente como:

$$
\bar{T}=\frac{1}{n} \sum_{i=1}^n t_i
$$

$$
\bar{T}=\frac{1}{22} \sum_{i=1}^{22} t_i=109.3636
$$

$$
\bar{h}=\frac{11}{22(109.3636)}=0.004571905
$$

Tabla 2: Tabla de vida Grupo 2

| $t_j$ | $d_j$ | $q_j$ | $n_j$ |
| ---: | :--- | :--- | ---: |
| $t_0$=0 | 0 | 0 | 22(22 unidades sobreviven >= 0 meses) |
| $t_1$=2 | 1 | 0 | 22(22 unidades sobreviven >= 2 meses ) |
| $t_2$=3 | 1 | 0 | 21 (21 unidades sobreviven >= 3 meses) |
| $t_3$=4 | 1 | 0 | 20(20 unidades sobreviven >= 4 meses ) |
| $t_4$=7 | 1 | 0 | 19(19 unidades sobreviven >= 7 meses ) |
| $t_5$=10 | 1 | 0 | 18(18 unidades sobreviven >= 10 meses) |
| $t_6$=22 | 1 | 0 | 17(17 unidades sobreviven >= 22 meses ) |
| $t_7$=28 | 1 | 0 | 16(16 unidades sobreviven >= 28 meses ) |
| $t_8$=29 | 1 | 0 | 15(15 unidades sobreviven >= 29 meses ) |
| $t_9$=32 | 1 | 0 | 14(14 unidades sobreviven >= 32 meses) |
| $t_10$=37 | 1 | 0 | 13(13 unidades sobreviven >= 37 meses ) |
| $t_11$=40 | 1 | 0 | 12(12 unidades sobreviven >= 40 meses ) |
| $t_12$=41 | 1 | 0 | 11(11 unidades sobreviven >= 41 meses) |
| $t_13$=54 | 1 | 0 | 10(10 unidades sobreviven >= 54 meses ) |
| $t_14$=61 | 1 | 0 | 9 (9 unidades sobreviven >= 61 meses ) |
| $t_15$=63 | 1 | 0 | 8(8 unidades sobreviven >= 63 meses) |
| $t_16$=71 | 1 | 6 | 7 unidades sobreviven >= 71 meses ) |
| TOTAL | 16 | 6 | 16+6=22 |


Ahora para el grupo 2, tl tiempo promedio $\hat{T}$ y $\hat{h}$ es:

$$
\bar{T}=\frac{1}{n} \sum_{i=1}^n t_i
$$

$$
\bar{T}=\frac{1}{22} \sum_{i=1}^{22} t_i=64.72727
$$

$$
\bar{h}=\frac{11}{22(109.3636)}=0.007724719
$$


A mayor Hazard es menor la probabilidad de supervivencia (Evidentemente, por eso el nombre), en este casi, se ve claramente que $\hat{h_1}<\hat{h_2}$ y a su vez; $\hat{T_1}>\hat{T_2}$. Basado en esto, se podria concluir que la supervivencia del grupo 2 es menor que la del grupo 1. Esto podria evidenciarse en el siguiente analisis grafico. 


```{r}
df$group = df$group %>% as.factor()
ggplot(df, aes(x = group, y = time, group = group, fill = group)) +
  geom_boxplot( color = "#404040")+
  stat_summary(fun = mean, geom = "point", shape = 20,
               size = 3, color = "red",position = position_dodge(width = 0.75))+
  labs(title = "Tiempo de respuesta por grupo", 
       x = "Grupo", 
       y = "Tiempo") +
  theme_bw()

```

Note que claramente las medias de ambos procesos (puntos rojos) se encuentran uno por encima de la otra. Esto da un indicio que los individuos del grupo 1 en comparación a los individuos del grupo 2 presentan un tiempo de supervivencia promedio mayor. 

En el grupo 1 el 50% de los datos esta aproximadamente por encima de 120 meses y el 50% por debajo, mientras que en el grupo 2 el 50% esta aproximadamente por encima de 40 meses y el 50% por debajo, es decir, que se presenta una diferencia significativa en el promedio de los tiempos hasta que el individuo falla entre el grupo 1 y el grupo 2

Dado esto, se procede a realizar entonces las estimaciones con KM (Kaplan-Meier):

## Estimacion de KM para grupo 1

$$
\begin{array}{|r|l|r|r|l|}
t_{(j)} & d_j & q_j & n_j & \hat{S}_{K M}\left(t_j\right) \\
\hline 0 & 0 & 0 & 22 & 1-\frac{0}{22}=1 \\
2 & 2 & 0 & 22 & 1 \mathrm{x}\left(1-\frac{2}{22}\right)=\frac{10}{11} \approx 0.9091 \\
12 & 1 & 0 & 20 & \frac{10}{11} \mathrm{x}\left(1-\frac{1}{20}\right)=\frac{19}{22} \approx 0.8636 \\
54 & 1 & 1 & 19 & \frac{19}{22} \mathrm{x}\left(1-\frac{1}{19}\right)=\frac{9}{11} \approx 0.8182 \\
68 & 1 & 0 & 17 & \frac{9}{11} \mathrm{x}\left(1-\frac{1}{17}\right)=\frac{144}{187} \approx 0.7701 \\
89 & 1 & 0 & 16 & \frac{144}{187} \mathrm{x}\left(1-\frac{1}{16}\right)=\frac{135}{187} \approx 0.7221 \\
96 & 2 & 5 & 15 & \frac{135}{187} \mathrm{x}\left(1-\frac{2}{15}\right)=\frac{117}{187} \approx 0.6257 \\
143 & 1 & 1 & 8 & \frac{117}{187} \mathrm{x}\left(1-\frac{1}{8}\right)=\frac{819}{146} \approx 0.5475 \\
146 & 1 & 2 & 6 & \frac{819}{1496} \mathrm{x}\left(1-\frac{1}{6}\right)=\frac{1365}{2992} \approx 0.4562 \\
168 & 1 & 2 & 3 & \frac{1365}{2992} \mathrm{x}\left(1-\frac{1}{3}\right)=\frac{455}{1496} \approx 0.3041 \\
\hline
\end{array}
$$
## Estimacion de KM para el grupo 2


$$
\begin{array}{|r|l|r|r|l|}
t_{(j)} & d_j & q_j & n_j & \hat{S}_{K M}\left(t_j\right) \\
\hline 0 & 0 & 0 & 22 & 1-\frac{0}{22}=1 \\
2 & 1 & 0 & 22 & 1 \mathrm{x}\left(1-\frac{1}{22}\right)=\frac{21}{22} \approx 0.9545 \\
3 & 1 & 0 & 21 & \frac{21}{22} \mathrm{x}\left(1-\frac{1}{21}\right)=\frac{10}{11} \approx 0.9091 \\
4 & 1 & 0 & 20 & \frac{10}{11} \mathrm{x}\left(1-\frac{1}{20}\right)=\frac{19}{22} \approx 0.8636 \\
7 & 1 & 0 & 19 & \frac{19}{22} \mathrm{x}\left(1-\frac{1}{19}\right)=\frac{9}{11} \approx 0.8182 \\
10 & 1 & 0 & 18 & \frac{9}{11} \mathrm{x}\left(1-\frac{1}{18}\right)=\frac{17}{22} \approx 0.7727 \\
22 & 1 & 0 & 17 & \frac{17}{22} \mathrm{x}\left(1-\frac{1}{17}\right)=\frac{8}{11} \approx 0.7273 \\
28 & 1 & 0 & 16 & \frac{8}{11} \mathrm{x}\left(1-\frac{1}{16}\right)=\frac{15}{22} \approx 0.6818 \\
29 & 1 & 0 & 15 & \frac{15}{22} \mathrm{x}\left(1-\frac{1}{15}\right)=\frac{7}{11} \approx 0.6364 \\
32 & 1 & 0 & 14 & \frac{7}{11} \mathrm{x}\left(1-\frac{1}{14}\right)=\frac{13}{22} \approx 0.5909 \\
37 & 1 & 0 & 13 & \frac{13}{22} \mathrm{x}\left(1-\frac{1}{13}\right)=\frac{6}{11} \approx 0.5455 \\
40 & 1 & 0 & 12 & \frac{6}{11} \mathrm{x}\left(1-\frac{1}{12}\right)=\frac{1}{2} \approx 0.5 \\
41 & 1 & 0 & 11 & \frac{1}{2} \mathrm{x}\left(1-\frac{1}{11}\right)=\frac{5}{11} \approx 0.4545 \\
54 & 1 & 0 & 10 & \frac{5}{11} \mathrm{x}\left(1-\frac{1}{10}\right)=\frac{9}{22} \approx 0.4091 \\
61 & 1 & 0 & 9 & \frac{9}{22} \mathrm{x}\left(1-\frac{1}{9}\right)=\frac{4}{11} \approx 0.3636 \\
63 & 1 & 0 & 8 & \frac{4}{11} \mathrm{x}\left(1-\frac{1}{8}\right)=\frac{7}{22} \approx 0.3182 \\
71 & 1 & 6 & 7 & \frac{7}{22} \mathrm{x}\left(1-\frac{1}{7}\right)=\frac{3}{11} \approx 0.2727 \\
\hline
\end{array}
$$


## Estimacion con NA - Grupo 1


| Falla Número | meses | hat(h)_(t) | hat(H)_(t) | S(t) |
| ---: | :--- | :--- | ---: | :--- |
| 1-2 | 2 | (2)/(22) | (2)/(22)~~0.0909 | 0.9131 |
| 3 | 12 | (1)/(20) | (1)/(22)+(1)/(20)=(31)/(220)~~0.1409 | 0.8686 |
| 4 | 54 | (1)/(19) | (31)/(220)+(1)/(19)=(809)/(4180)~~0.1935 | 0.8240 |
| 5 | 68 | (1)/(17) | (809)/(4180)+(1)/(17)=(17933)/(771060)~~0.2524 | 0.7769 |
| 6 | 89 | (1)/(16) | (17933)/(77960)+(1)/(16)=(89497)/(284940)~~0.3149 | 0.7299 |
| 7-8 | 96 | (2)/(15) | (89497)/(284240)+(2)/(15)=(382187)/(852720)~~0.4482 | 0.6388 |
| 9 | 143 | (1)/(8) | (382187)/(852720)+(1)/(8)~~0.5732 | 0.5637 |
| 10 | 146 | (1)/(6) | 0.5732+(1)/(6)~~0.7399 | 0.4772 |
| 11 | 168 | (1)/(3) | 0.7399+(1)/(3)~~1.0732 | 0.3419 |


## Estimacion con NA - Grupo 2

| Falla Número | meses | hat(h)_(t) | hat(H)_(t) | S(t) |
| ---: | :--- | :---: | ---: | :--- |
| 1 | 2 | (1)/(22) | (1)/(22)~~0.0455 | 0.9556 |
| 2 | 3 | (1)/(21) | (1)/(22)+(1)/(21)=(43)/(462)~~0.0931 | 0.9111 |
| 3 | 4 | (1)/(20) | (43)/(462)+(1)/(20)=(661)/(460)~~0.1431 | 0.8667 |
| 4 | 7 | (1)/(19) | (661)/(4620)+(1)/(19)=(17797)/(87780)~~0.1957 | 0.8223 |
| 5 | 10 | (1)/(18) | (17)/(87799)+(1)/(18)=(66167)/(263340)~~0.2513 | 0.7778 |
| 6 | 22 | (1)/(17) | ~~0.3101 | 0.7334 |
| 7 | 28 | (1)/(16) | ~~0.3716 | 0.6896 |
| 8 | 29 | (1)/(15) | ~~0.4393 | 0.6445 |
| 9 | 32 | (1)/(14) | ~~0.5107 | 0.6001 |
| 10 | 37 | (1)/(13) | ~~0.5876 | 0.5557 |
| 11 | 40 | (1)/(12) | ~~0.6709 | 0.5112 |
| 12 | 41 | (1)/(11) | ~~0.7618 | 0.4668 |
| 13 | 54 | (1)/(10) | ~~0.8618 | 0.4224 |
| 14 | 61 | (1)/(9) | ~~0.9730 | 0.3779 |
| 15 | 63 | (1)/(8) | ~~1.0980 | 0.3335 |
| 16 | 71 | (1)/(7) | ~~1.2408 | 0.2891 |


\subsection{ejercicio 3}

Usando SAS o R y los datos del numeral anterior, obtenga estimaciones para la curva de supervivencia usando KM y NA


```{r}
df$group<-as.factor(df$group)
df=data.frame(df)
KM_fit <- survfit(Surv(time, status) ~ group, data = df)
summary(KM_fit)
```







