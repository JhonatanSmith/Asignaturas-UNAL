---
title: "Formulas Muestreo Estratificado"
author: "Jhonatan Smith Garcia"
date: "3/7/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# 1) Media estradificada mu (y_bar_est) Será Y-barra estratificada

ESTO SE COLOCA EN EL PARCIAL

$\bar{y}_{est} = \sum_{h=1}^H(Nh/N)*\bar{y}_h$ 

Donde:

```{r}
Nh = c(155,62,93) #Poblacion en cada estrato
N = sum(Nh)  #Poblacion total (un numero, no vector)
y_h = c(33.90,25.12,19) #Será el promedio en cada estrato
y_bar_est = sum((Nh/N)*y_h)
y_bar_est
  
```

 varianza estratificada de la media "Y barra estratificado":

$Var[\bar{y}_{est}]=\frac{1}{N^2}*Var[\bar{y_h}]$ Donde;

$Var[\bar{y_h}]=(1-\frac{n_h}{N_h})*\frac{\sigma^2}{n_h}$
  
```{r}
nh = c(20,8,12) #Vector con los valores de las muestras n-h
n = sum(nh)

#En este caso dieron la desviacion, se eleva al cuadrado para varianza

sh = c(5.95,15.25,9.36) #Vector con las desviacion (muestrales)
s2h = sh^2#Vector con las varianzas se trabaja con este siempre
#s2h = c(5.95,15.25,9.36) #Vector con las varianzas (muestrales)


var_yh_bar= (1-nh/Nh)*s2h/nh #Varianza de Y-Barra para cada estrato

var_y_est = 1/N^2*sum(Nh^2*var_yh_bar) # Varianza media estratificada

var_y_est

```

 Un IC para Media mu estratificada (este es el B, limite del error estimado) =
 
```{r}
B1 = 2*ee 
B1
IC1 = c(y_bar_est-B1,y_bar_est+B1)
IC1 #ESTE ES UN IC APROXIMADAMENTE DEL 95%
```
 

si n>30 entonces se usa $B=Z_\frac{\alpha}{2}*\sqrt{\hat{Var}(\bar{y}_{est})}$
si n<30 entonces se usa $B=t_{\frac{\alpha}{2},n-H}*\sqrt{\hat{Var}(\bar{y}_{est})}$

El IC será $\bar{y}_{est}\pm B$

```{r}
#Para n >30
alpha=0.05
B = qnorm(1-alpha/2)*sqrt(var_y_est)
IC = c(y_bar_est-B,y_bar_est+B) 
IC
```
```{r}
#Para n<30
alpha = 0.05
H = length(Nh) #Cantidad de estratos
B = qt(1-alpha/2,n-H)*sqrt(var_y_est)
IC = c(y_bar_est-B,y_bar_est+B) 
IC
```
# 2) Total Poblacional MAE:

$\hat{T}_{est}=N*\bar{y}_{est}=\sum^H_{h=1}{N_h*\bar{y}_h}$

```{r}
t_est= sum(N*y_bar_est)
t_est
```
 Varianza total poblacional estratificado:
 
 $Var[\hat{t}_{est}]=\sum{N_h^2*Var[\bar{y}_{h}}]$
 
```{r}
var_t_est = sum(Nh^2*var_yh_bar)
var_t_est
#ERROR DE ESTIMACION ES RAIZ DE LA VARIANZA CALCULADA
ee = sqrt(var_t_est)
ee
```
  Calculando el IC con el EE se tiene que:
  
```{r}
B1 = 2*ee
B1
IC1 = c(t_est-B1,t_est+B1)
IC1
```
  
  
  Un IC para Tao estratificada (este es el B, limite del error estimado) =

si n>30 entonces se usa $B=Z_\frac{\alpha}{2}*\sqrt{\hat{Var}(\hat{t}_{est})}$
si n<30 entonces se usa $B=t_{\frac{\alpha}{2},n-H}*\sqrt{\hat{Var}(\hat{t}_{est})}$

El IC será $\hat{t}_{est}\pm B$
```{r}
#Para n >30
alpha=0.05
B = qnorm(1-alpha/2)*sqrt(var_t_est)
IC = c(t_est-B,t_est+B) 
IC
```
```{r}
#Para n<30
alpha = 0.05
H = length(Nh) #Cantidad de estratos
B = qt(1-alpha/2,n-H)*sqrt(var_t_est)
IC = c(t_est-B,t_est+B) 
IC
```
#  3) Proporcion 

$\hat{P}_{est}=\sum^H_{h=1}\frac{N_h}{N}*p_h$

ademas;

$\hat{A}_{est}=N*\hat{P}_{est}$

```{r}
Nh = c(4000,6000,10000) # Tamaño total muestra
N = sum(Nh)
nh = c(36,40,44)
ph= c(0.9,0.6,0.2)#Vector de coordenadas proporcionales
p_est = sum((Nh/N)*ph) 
A_est = N*p_est
```

Varianza proporcion estratificada y el IC de aprox 95%

```{r}
Nh = c(4000,6000,10000) # Tamaño total muestra
N = sum(Nh)
nh = c(36,40,44)
qh= 1-ph
#Recuerde que varianza proporcion esta dada por:
var_ph = (1 - nh/Nh)*ph*qh/(nh-1)# <- es la varianza para cada ph.
var_ph = ph*qh/(nh-1)*(Nh-nh)/(N)
var_ph = c(0.002548,0.006113,0.003704) #Varianzas de cada proporcion

var_p_est = 1/N^2*sum(Nh^2*var_ph)
var_p_est

```

```{r}
ee = sqrt(var_p_est)
ee

B = ee*2
B
```
Ahora, un IC de apro 95% es:

```{r}
IC_P_est = c(p_est-B,p_est+B)
IC_P_est
```

 **Ahora para el total poblacional que cumplen cierta condi**
 
```{r}
A_est = N*p_est
A_est

var_A_est = N^2*var_p_est
var_A_est

ee = sqrt(var_A_est)
ee

```
*Ahora, el IC será este, de aprox 95%*

```{r}

B = 2*ee
IC_A_est = c(A_est-B,A_est+B)
IC_A_est
```
 
# Tamaño muestra n

La formula tamaño de la muestra para la media con LEE B es:

$n=\frac{\sum \frac{N_h^2*\sigma_h^2}{w_h}}{N^2*D+\sum^H_{h=1} N_h*\sigma_h^2} $

Donde se tiene que $w_h=\frac{n_h}{n}$ y ademas

$D= \frac{1}{N^2}*\sum N_h^2*\frac{\sigma_h^2}{n*w_h}-\frac{1}{N^2}\sum N_h^2*\frac{\sigma^2}{N_h}$

*OJO, recuerde que*


$D=Var[\bar{y_{est}}]=\frac{B^2}{Z^2}$ 

donde 

$B=Z*\sqrt{Var[\bar{y_{est}}]}=Z*E.E(\bar{y}_{est})$ 



```{r}
B= 4 #Limite del error
Z = qnorm(0.975)
s2h = c(25,225,100) #Sigma cuadrado sacado de la mmuestra
wh = w_h_proporcional #Aqui va la afijacion de la muestra
Nh = c(112,68,39) #Total cd estrato
N = sum(Nh) # Total poblacional
D = B^2/(Z^2* #N^2) # D es igual a la varianza de ybar estratificado


#OJO: D ES IGUALA B^2/Z^2 EN GENERAL PERO, PARA CALCULAR EL **TOTAL** POBLACIONAL, SE USA LA EXPRESION DE D = B^2/(Z^2*N^2) dividido sobre N cuadrado

n_optimo = sum(((Nh^2*s2h)/wh))/(N^2*D+sum(Nh*s2h))
n_optimo
asignacion = wh*n_optimo
asignacion

```
Esto quiere decir que se requieren 57 mmuestras con esa asignacion


# 4. Afijacion de la muestra

*Igual* n*wh

*Porpocional al tamaño del estrato*

$ w_h= \frac{N_h}{\sum(N_h)}$ 

```{r}
w_h_proporcional = (Nh)/(sum(Nh))
```

*Afijacion Optima de Neyman (Costos iguales)*

```{r}
wh_optima_costo_igual = (Nh*sh)/(sum(Nh*sh)) #Neyman

```
 
*Afijacion que minimiza el costo/varianza*

```{r}

# ESTA FORMULA SE REEMPLAZA TAMAÑO n
sh = sqrt(s2h)
numerador = (Nh*sh)/(sqrt(ch))
denominador = sum((Nh*sh)/(sqrt(ch)))
wh_optmina_muestra = numerador/denominador


```

# Ejercicio 11.



